<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>VK Analytics ‚Äî –ü–æ–ª–Ω—ã–π –≤–µ–±‚Äë–∫–ª–∏–µ–Ω—Ç</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; max-width: 1200px; margin: 0 auto; padding: 20px; }
    .section { margin: 30px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
    button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    .status { font-weight: bold; padding: 10px; border-radius: 4px; }
    .done { background: #d4edda; color: #155724; }
    .running { background: #fff3cd; color: #856404; }
    .error { background: #f8d7da; color: #721c24; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f8f9fa; }
    .top-post { background: #e7f3ff; }
  </style>
</head>
<body>
  <h1>üîç VK Analytics</h1>

  <!-- 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ -->
  <div class="section">
    <h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h3>
    <input id="projectName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" value="–ê–Ω–∞–ª–∏–∑ –í–æ–ª–≥–ì–¢–£"/>
    <button onclick="createProject()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
    <div id="projectsList"></div>
  </div>

  <!-- 2. –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ -->
  <div class="section">
    <h3>üöÄ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞</h3>
    <input id="projectId" placeholder="ID –ø—Ä–æ–µ–∫—Ç–∞" value="1"/>
    <input id="groupId" placeholder="ID –≥—Ä—É–ø–ø—ã VK" value="1"/>
    <input id="postCount" type="number" placeholder="–ü–æ—Å—Ç–æ–≤" value="50"/>
    <button id="startBtn" onclick="startRun()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
    <div id="runStatus" class="status" style="display:none;"></div>
  </div>

  <!-- 3. –†–µ–∑—É–ª—å—Ç–∞—Ç -->
  <div class="section" id="resultSection" style="display:none;">
    <h3>üìä –û—Ç—á—ë—Ç</h3>
    <div id="basicStats"></div>
    <canvas id="viewsChart" width="400" height="200"></canvas>
    <h4>üèÜ –¢–æ–ø‚Äë10 –ø–æ—Å—Ç–æ–≤ –ø–æ –ª–∞–π–∫–∞–º</h4>
    <table id="topPosts">
      <thead><tr><th>ID</th><th>–î–∞—Ç–∞</th><th>–¢–µ–∫—Å—Ç</th><th>–õ–∞–π–∫–∏</th></tr></thead>
      <tbody></tbody>
    </table>
    <h4>ü§ñ ML‚Äë—Å–∫–æ—Ä–∏–Ω–≥ (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ–ø–∞)</h4>
    <table id="mlScoring">
      <thead><tr><th>ID</th><th>–õ–∞–π–∫–∏</th><th>–ö–æ–º–º–µ–Ω—Ç—ã</th><th>Score</th><th>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ —Ç–æ–ø</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const API_BASE = 'http://localhost:8000';

let currentRunId = null;
let statusInterval = null;

// 1. –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
async function createProject() {
  const name = document.getElementById('projectName').value;
  try {
    const resp = await fetch(`${API_BASE}/projects`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name})
    });
    const project = await resp.json();
    document.getElementById('projectId').value = project.id;
    document.getElementById('projectsList').innerHTML = `<div>‚úÖ –°–æ–∑–¥–∞–Ω –ø—Ä–æ–µ–∫—Ç ID: ${project.id}</div>`;
  } catch(e) {
    alert('–û—à–∏–±–∫–∞: ' + e);
  }
}

// 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
async function startRun() {
  const projectId = parseInt(document.getElementById('projectId').value);
  const groupId = parseInt(document.getElementById('groupId').value);
  const count = parseInt(document.getElementById('postCount').value);

  const btn = document.getElementById('startBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';

  try {
    const resp = await fetch(`${API_BASE}/projects/${projectId}/runs`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({group_id: groupId, count})
    });
    const run = await resp.json();
    currentRunId = run.id;

    document.getElementById('runStatus').innerHTML = `üöÄ Run ID: ${run.id} (—Å—Ç–∞—Ç—É—Å: ${run.status})`;
    document.getElementById('runStatus').className = 'status running';
    document.getElementById('runStatus').style.display = 'block';

    pollStatus();
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e);
    btn.disabled = false;
    btn.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å';
  }
}

// 3. –û–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞
async function pollStatus() {
  if (!currentRunId) return;

  try {
    const resp = await fetch(`${API_BASE}/runs/${currentRunId}`);
    const status = await resp.json();

    document.getElementById('runStatus').innerHTML = `üìä Run ID: ${status.id} (—Å—Ç–∞—Ç—É—Å: <b>${status.status}</b>)`;

    if (status.status === 'done') {
      document.getElementById('runStatus').className = 'status done';
      clearInterval(statusInterval);
      showReport();
    } else if (status.status === 'error') {
      document.getElementById('runStatus').className = 'status error';
      document.getElementById('runStatus').innerHTML += `<br>‚ùå ${status.error_message}`;
      clearInterval(statusInterval);
    } else {
      document.getElementById('runStatus').className = 'status running';
    }
  } catch(e) {
    console.error(e);
  }
}

// 4. –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á—ë—Ç
async function showReport() {
  try {
    const resp = await fetch(`${API_BASE}/runs/${currentRunId}/report`);
    const report = await resp.json();
    
    // Basic stats
    const basic = report.basic;
    document.getElementById('basicStats').innerHTML = `
      <h4>üìà –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (${basic.total_posts} –ø–æ—Å—Ç–æ–≤):</h4>
      <p>üî• <b>–õ–∞–π–∫–æ–≤:</b> ${basic.total_likes.toLocaleString()} (—Å—Ä. ${basic.avg_likes})</p>
      <p>üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–æ–≤:</b> ${basic.total_comments.toLocaleString()} (—Å—Ä. ${basic.avg_comments})</p>
      <p>üîÑ <b>–†–µ–ø–æ—Å—Ç–æ–≤:</b> ${basic.total_reposts.toLocaleString()} (—Å—Ä. ${basic.avg_reposts})</p>
      <p>üëÅÔ∏è <b>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:</b> ${basic.total_views.toLocaleString()} (—Å—Ä. ${basic.avg_views.toLocaleString()})</p>
    `;

    // –¢–æ–ø –ø–æ—Å—Ç—ã
    const tbody = document.querySelector('#topPosts tbody');
    tbody.innerHTML = '';
    basic.top_posts_by_likes.slice(0,10).forEach((post, i) => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = post.id;
      row.insertCell(1).textContent = post.date;
      row.insertCell(2).innerHTML = `<a href="https://vk.com/wall${post.owner_id}_${post.id}" target="_blank">${post.text.substring(0,80)}...</a>`;
      row.insertCell(3).textContent = post.likes_count;
    });

    // ML scoring (–¢–û–ü-10)
    const mlTbody = document.querySelector('#mlScoring tbody');
    mlTbody.innerHTML = '';
    report.predict.items.slice(0,10).forEach(item => {
      const row = mlTbody.insertRow();
      row.insertCell(0).textContent = item.id;
      row.insertCell(1).textContent = item.likes_count;
      row.insertCell(2).textContent = item.comments_count;
      row.insertCell(3).textContent = item.score_top;
      row.insertCell(4).textContent = item.predicted_top ? '‚≠ê –¢–û–ü' : '‚Äî';
    });

    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑';

  } catch(e) {
    document.getElementById('runStatus').innerHTML += `<br>‚ùå –û—à–∏–±–∫–∞ –æ—Ç—á—ë—Ç–∞: ${e}`;
  }
}


// –ê–≤—Ç–æ–æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
function startPolling() {
  statusInterval